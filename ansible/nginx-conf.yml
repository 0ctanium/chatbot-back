---
- name: Update Nginx conf

  hosts: localhost

  vars_files:

  vars:
    - gitDir: '/var/www/git/'
    - appsDir: '/var/www'
    - backDir: 'chatbot-back'
    - frontDir: 'chatbot-front'

  tasks:
    - name: copy the nginx config file
      copy:
        src: '{{ gitDir }}/nginx.conf'
        dest: '/etc/nginx/nginx.conf'
      become: yes

    - name: copy the nginx site config file
      copy:
        src: '{{ gitDir }}/nginx_conf.cfg'
        dest: '/etc/nginx/sites-available/{{ frontDir }}.cfg'

    - name: add server name to the nginx site config file
      lineinfile:
        path: '/etc/nginx/sites-available/{{ frontDir }}.cfg'
        insertbefore: '^    location / {'
        line: '    server_name  {{ botDomain }};'

    - name: create symlink
      file:
        src: '/etc/nginx/sites-available/{{ frontDir }}.cfg'
        dest: '/etc/nginx/sites-enabled/default'
        state: link

    - name: restart nginx
      service:
        name: nginx
        state: restarted

    - name: Install SSL certificate
      command:
        cmd: 'certbot --nginx -d {{ botDomain }} -n --redirect --agree-tos -m vincent.laine@beta.gouv.fr'
